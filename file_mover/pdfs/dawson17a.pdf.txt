An Infinite Hidden Markov Model With Similarity-Biased Transitions

Colin Reimer Dawson

1

Chaofan Huang

Abstract
We describe a generalization of the Hierarchical
Dirichlet Process Hidden Markov Model (HDPHMM) which is able to encode prior information that state transitions are more likely between “nearby” states. This is accomplished
by defining a similarity function on the state
space and scaling transition probabilities by pairwise similarities, thereby inducing correlations
among the transition distributions. We present
an augmented data representation of the model
as a Markov Jump Process in which: (1) some
jump attempts fail, and (2) the probability of success is proportional to the similarity between the
source and destination states. This augmentation restores conditional conjugacy and admits a
simple Gibbs sampler. We evaluate the model
and inference method on a speaker diarization
task and a “harmonic parsing” task using fourpart chorale data, as well as on several synthetic
datasets, achieving favorable comparisons to existing models.

1

Clayton T. Morrison

ing a “stick” off of the remaining weight according to a
Beta (1, γ) distribution. The parameter γ > 0 is known
as the concentration parameter and governs how quickly
the weights tend to decay, with large γ corresponding to
slow decay, and hence more weights needed before a given
cumulative weight is reached. This stick-breaking process
is denoted by GEM (Ewens, 1990; Sethuraman, 1994) for
Griffiths, Engen and McCloskey. We thus have a discrete
probability measure, G0 , with weights βj at locations θj ,
j = 1, 2, . . . , defined by
i.i.d.

θj ∼ H

β ∼ GEM(γ).

The hierarchical Dirichlet process hidden Markov model
(HDP-HMM) (Beal et al., 2001; Teh et al., 2006) is a
Bayesian model for time series data that generalizes the
conventional hidden Markov Model to allow a countably
infinite state space. The hierarchical structure ensures that,
despite the infinite state space, a common set of destination
states will be reachable with positive probability from each
source state. The HDP-HMM can be characterized by the
following generative process.
Each state, indexed by j, has parameters, θj , drawn
from a base measure, H. A top-level sequence of state
weights, β = (β1 , β2 , . . . ), is drawn by iteratively break1

Oberlin College, Oberlin, OH, USA 2 The University of Arizona, Tucson, AZ, USA. Correspondence to: Colin Reimer Dawson <cdawson@oberlin.edu>.
Proceedings of the 34 th International Conference on Machine
Learning, Sydney, Australia, PMLR 70, 2017. Copyright 2017
by the author(s).

(1)

G0 drawn in this way is a Dirichlet Process (DP) random
measure with concentration γ and base measure H.
The actual transition distribution, π j , from state j, is drawn
from another DP with concentration α and base measure
G0 :
i.i.d.
π j ∼ DP(αG0 )
j = 0, 1, 2, . . .
(2)
where π 0 represents the initial distribution. The hidden
state sequence, z1 , z2 , . . . zT is then generated according to
z1 | π 0 ∼ Cat(π 0 ), and
zt | zt−1 , π zt−1 ∼ Cat(π zt−1 )

1. Introduction and Background

2

t = 1, 2, . . . , T

(3)

Finally, the emission distribution for state j is a function of
θj , so that observation yt is drawn according to
yt | zt , θzt ∼ F (θzt )

(4)

A shortcoming of the HDP prior on the transition matrix is
that it does not use the fact that the source and destination
states are the same set: that is, each π j has a special element which corresponds to a self-transition. In the HDPHMM, however, self-transitions are no more likely a priori
than transitions to any other state. The Sticky HDP-HMM
(Fox et al., 2008) addresses this issue by adding an extra
mass κ at location j to the base measure of the DP that
generates π j . That is, (2) is replaced by
π j ∼ DP(αG0 + κδθj ).

(5)

An alternative approach that treats self-transitions as special is the HDP Hidden Semi-Markov Model (HDPHSMM; Johnson & Willsky (2013)), wherein state duration distributions are modeled separately, and ordinary selftransitions are ruled out. However, while both of these

An Infinite HMM With Similarity-Biased Transitions

models have the ability to privilege self-transitions, they
contain no notion of similarity for pairs of states that are
not identical: in both cases, when the transition matrix is
integrated out, the prior probability of transitioning to state
j 0 depends only on the top-level stick weight associated
with state j 0 , and not on the identity or parameters of the
previous state j.
The two main contributions of this paper are (1) a generalization of the HDP-HMM, which we call the HDP-HMM
with local transitions (HDP-HMM-LT) that allows for a geometric structure to be defined on the latent state space, so
that “nearby” states are a priori more likely to have transitions between them, and (2) a simple Gibbs sampling algorithm for this model. The “LT” property is introduced by
elementwise rescaling and then renormalizing of the HDP
transition matrix. Two versions of the similarity structure
are illustrated: in one case, two states are similar to the extent that their emission distributions are similar. In another,
the similarity structure is inferred separately. In both cases,
we give augmented data representations that restore conditional conjugacy and thus allow a simple Gibbs sampling
algorithm to be used for inference.
A rescaling and renormalization approach similar to the
one used in the HDP-HMM-LT is used by Paisley et al.
(2012) to define their Discrete Infinite Logistic Normal
(DILN) model, an instance of a correlated random measure
(Ranganath & Blei, 2016), in the setting of topic modeling.
There, however, the contexts and the mixture components
(topics) are distinct sets, and there is no notion of temporal dependence. Zhu et al. (2016) developed an HMM
based directly on the DILN model1 . Both Paisley et al. and
Zhu et al. employ variational approximations, whereas we
present a Gibbs sampler, which converges asymptotically
to the true posterior. We discuss additional differences between our model and the DILN-HMM in Sec. 2.2.
One class of application in which it is useful to incorporate
a notion of locality occurs when the latent state sequence
consists of several parallel chains, so that the global state
changes incrementally, but where these increments are not
independent across chains. Factorial HMMs (Ghahramani
et al., 1997) are commonly used in this setting, but this ignores dependence among chains, and hence may do poorly
when some combinations of states are much more probable
than suggested by the chain-wise dynamics.
Another setting where the LT property is useful is when
there is a notion of state geometry that licenses syllogisms:
e.g., if A frequently leads to B and C and B frequently leads
to D and E, then it may be sensible to infer that A and C
may lead to D and E as well. This property is arguably
1
We thank an anonymous ICML reviewer for bringing this paper to our attention.

present in musical harmony, where consecutive chords are
often (near-)neighbors in the “circle of fifths”, and small
steps along the circle are more common than large ones.
The paper is structured as follows: In section 2 we define the model. In section 3, we develop a Gibbs sampling algorithm based on an augmented data representation, which we call the Markov Jump Process with Failed
Transitions (MJP-FT). In section 4 we test two versions
of the model: one on a speaker diarization task in which
the speakers are inter-dependent, and another on a fourpart chorale corpus, demonstrating performance improvements over state-of-the-art models when “local transitions”
are more common in the data. Using sythetic data from
an HDP-HMM, we show that the LT variant can learn
not to use its similarity bias when the data does not support it. Finally, in section 5, we conclude and discuss
the relationships between the HDP-HMM-LT and existing
HMM variants. Code and additional details are available at
http://colindawson.net/hdp-hmm-lt/

2. An HDP-HMM With Local Transitions
We wish to add to the transition model the concept of a
transition to a “nearby” state, where transitions between
states j and j 0 are more likely a priori to the extent that
they are “nearby” in some similarity space. In order to
accomplish this, we first consider an alternative construction of the transition distributions, based on the Normalized Gamma Process representation of the DP (Ishwaran &
Zarepour, 2002; Ferguson, 1973).
2.1. A Normalized Gamma Process representation of
the HDP-HMM
The Dirichlet Process is an instance of a normalized completely random measure (Kingman,
P∞ 1967; Ferguson, 1973),
that can be defined as G = k=1 π̃k δθk , where
ind.

πk ∼ Gamma(αβk , 1) T =

∞
X
k=1

πk

π̃k =

πk
,
T

(6)

δθ is a measure assigning 1 to sets if they contain
θ and 0
P
otherwise, and subject to the constraint that k≥1 βk = 1
and 0 < α < ∞. It has been shown (Ferguson, 1973; Paisley et al., 2012; Favaro et al., 2013) that the normalization
constant T is positive and finite almost surely,P
and that G is
∞
distributed as a DP with base measure G0 = k=1 βk δθk .
If we draw β = (β1 , β2 , . . . ) from the GEM(γ) stickbreaking process, draw an i.i.d. sequence of θk from a base
measure H, and then draw an i.i.d. sequence of random
measures, {Gj }, j = 1, 2, . . . , from the above process, this
defines a Hierarchical Dirichlet Process (HDP). If each Gj
is associated with the hidden states of an HMM, π is the
infinite matrix where entry πjj 0 is the j 0 th mass associated

An Infinite HMM With Similarity-Biased Transitions

with the jth random measure, and Tj is the sum of row j,
then we obtain the prior for the HDP-HMM, where
p(zt | zt−1 , π) = π̃zt−1 zt = πjj 0 /Tj

(7)

2.2. Promoting “Local” Transitions
In the HDP prior, the rows of the transition matrix are conditionally independent. We wish to relax this assumption,
to incorporate possible prior knowledge that certain pairs of
states are “nearby” in some sense and thus more likely than
others to produce large transition weights between them (in
both directions); that is, transitions are likely to be “local”. We accomplish this by associating each latent state
j with a location `j in some space Ω, introducing a “similarity function” φ : Ω × Ω → (0, 1], and scaling each
element πjj 0 by φjj 0 = φ(`j , `j 0 ). For example, we might
wish to define a (possibly asymmetric) divergence function
d : Ω × Ω → [0, ∞) and set φ(`j , `j ) = exp{−d(`j , `j 0 )}
so that transitions are less likely the farther apart two states
are. By setting φ ≡ 1, we obtain the standard HDP-HMM.
The DILN-HMM (Zhu et al., 2016), employs a similar
rescaling of transition probabilities via an exponentiated
Gaussian Process, following (Paisley et al., 2012), but the
scaling function must be positive semi-definite, and in particular symmetric, whereas in the HDP-HMM-LT, φ need
only take values in (0, 1]. Moreover, the DILN-HMM does
not allow the scales to be tied to other state parameters, and
hence encode an independent notion of similarity.
Letting ` = (`1 , `2 , . . . ), we can replace (6) for j ≥ 1 by
πjj 0 | β, ` ∼ Gamma(αβj 0 , 1),

Tj =

∞
X

πjj 0 φjj 0

j 0 =1

π̃jj 0 = πjj 0 φjj 0 /Tj ,

(8)

p(zt | zt−1 , π, `) = π̃zt−1 zt .

Since the φjj 0 are positive and bounded above by 1,
X
0 < πj1 φj1 ≤ Tj ≤
πjj 0 < ∞

(9)

j0

almost surely, where the last inequality carries over from
the original HDP. The prior means of the unnormalized
transition distributions, π j are then proportional (for each
j) to αβφj where φj = (φj1 , φj2 , . . . ).
The distribution of the latent state sequence z given π and
` is now
p(z | π, `) =
=

T
Y
t=1
∞
Y
j=1

PT

−nz

πzt−1 zt φzt−1 zt Tzt−1 t−1
Tj−1

∞
Y

·

n

0

n

2.3. The HDP-HMM-LT as the Marginalization of a
Markov Jump Process with “Failed” Transitions
In this section, we define a stochastic process that we
call the Markov Jump Process with Failed Transitions
(MJP-FT), from which we obtain the HDP-HMM-LT by
marginalizing over some of the variables. By reinstating
these auxiliary variables, we obtain a simple Gibbs sampling algorithm over the full MJP-FT, which can be used
to sample from the marginal posterior of the variables used
by the HDP-HMM-LT.
Let β, π, ` and Tj , j = 1, 2, . . . be defined as in the
last section. Consider a continuous-time Markov Process
over the states j = 1, 2, . . . , and suppose that if the process makes a jump to state zt at time τt , the next jump,
which is toPstate zt+1 , occurs at time τt + ũt , where
ũt ∼ Exp( j 0 πjj 0 ), and p(zt+1 = j 0 | zt = j) ∝ πjj 0 ,
independent of ũt . Note that in this formulation, unlike in
standard formulations of Markov Jump Processes, we are
assuming that self-jumps are possible.
If we only observe the jump sequence z and not the holding times ũt , this is an ordinary Markov chain with transition matrix row-proportional to π. If we do not observe
the jumps directly, but instead an observation is generated
once per jump from a distribution that depends on the state
being jumped to, then we have an ordinary HMM whose
transition matrix is obtained by normalizing π; that is, we
have the HDP-HMM.
We modify this process as follows. Suppose each jump attempt from state j to state j 0 has probability (1 − φjj 0 ) of
failing, in which case no transition occurs and no observation is generated. Assuming independent failures, the rates
of successful and failed jumps from j to j 0 are πjj 0 φjj 0 and
πjj 0 (1 − φjj 0 ), respectively. The probability that the first
successful jump is to state j 0 (that is, that zt+1 = j 0 ) is
proportional to the rate of successful jump attempts to j 0 ,
which is πjj 0 φjj 0 . Conditioned on zt , the holding time, ũt ,
is independent of zt+1 and is distributed as Exp(T
P zt ). We
denote the total time spent in state j by uj = t:zt =j ũt ,
where, as the sum of i.i.d. Exponentials,
ind.

(10)
πjjjj0 φjjjj0

P
0
and nj· =
j 0 njj is the total number of visits to state
j. Since Tj is a sum over products of πjj 0 and φjj 0 terms,
the posterior for π is no longer a DP. However, conditional
conjugacy can be restored by a data-augmentation process
with a natural interpretation, which is described next.

0

j 0 =1

0
where njj 0 =
t=1 I(zt−1 = j, zt = j ) is the num0
ber of transitions from state j to state j in the sequence z

uj | z, π, θ ∼ Gamma(nj· , Tj )

(11)

During this period there will be qjj 0 failed attempts to jump
to state j 0 , where qjj 0 ∼ Poisson(uj πjj 0 (1 − φjj 0 )) are independent. This data augmentation bears some conceptual
similarity to the Geometrically distributed ρ auxiliary variables introduced to the HDP-HSMM (Johnson & Willsky,

An Infinite HMM With Similarity-Biased Transitions

2013) to restore conditional conjugacy. However, there are
key differences: first, ρ measure how many steps the chain
would have remained in state j under Markovian dynamics, whereas our u represents putative continuous holding
times between each transition, and second ρ allows for the
restoration of a zeroed out entry in each row, whereas u allows us to work with unnormalized π entries, avoiding the
need to restore zeroed out entries in the HSMM-LT
Incorporating u = {uj } and Q = {qjj 0 } as augmented
data simplifies the likelihood for π, yielding
p(z,u, Q | π) = p(z | π)p(u | z, π)p(Q | u, π)

(12)

where dependence on ` has been omitted for conciseness.
After grouping terms and omitting terms that do not depend
on π, this proportional (as a function of π) to
Y Y n 0 +q 0 n 0
jj
πjjjj0
φjjjj0 (1 − φjj 0 )qjj0 e−πjj0 uj
(13)
j

j0

Conveniently, the Tj have canceled, and the exponential
terms involving πjj 0 and φjj 0 in the Gamma and Poisson
distributions of uj and qjj 0 combine to cause φjj 0 to vanish.
2.4. Sticky and Semi-Markov Generalizations
We note that the local transition property of the HDPHMM-LT can be combined with the Sticky property of
the Sticky HDP-HMM (Fox et al., 2008), or the nongeometric duration distributions of the HDP-HSMM (Johnson & Willsky, 2013), to add additional prior weight on
self-transitions. In the former case, no changes to inference
are needed; one can simply add the the extra mass κ to the
shape parameter of the Gamma prior on the πjj , and employ the same auxiliary variable method used by Fox et al.
to distinguish “Sticky” from “regular” self-transitions. For
the semi-Markov case, we can fix the diagonal elements
of π to zero, and allow Dt observations to be emitted i.i.d.
according to a state-specific duration distribution, and sample the latent state sequence using a suitable semi-Markov
message passing algorithm (Johnson & Willsky, 2013). Inference for the φ matrix is not affected, since the diagonal elements are assumed to be 1. Unlike in the original representation of the HDP-HSMM, no further dataaugmentation is needed, as the (continuous) durations u
already account for the normalization of the π.
2.5. Obtaining the Factorial HMM as a Limiting Case

uniform with probability 1, so the dynamics are controlled
entirely by φ. If A(d) is the transition matrix for chain d,
then setting φ(`j , `j 0 ) = exp −d(`j , `j 0 ) with asymmetric
P
(d)
“divergences” d(`j , `j 0 ) = − d log(A`jd ,`j0 d ) yields the
factorial transition model.
2.6. An Infinite Factorial HDP-HMM-LT
Nonparametric extensions of the factorial HMM, such as
the infinite factorial hidden Markov Model (Gael et al.,
2009) and the infinite factorial dynamic model (Valera
et al., 2015), have been developed in recent years by making use of the Indian Buffet Process (Ghahramani & Griffiths, 2005) as a state prior. It would be conceptually
straightforward to combine the IBP state prior with the similarity bias of the LT model, provided the chosen similarity
function is uniformly bounded above on the space of infinite length binary vectors (for example, take φ(u, v) to
be the exponentiated negative Hamming distance between
u and v). Since the number of differences between two
draws from the IBP is finite with probability 1, this yields
a reasonable similarity metric.

3. Inference
We develop a Gibbs sampling algorithm based on the MJPFT representation described in Sec. 2.3, augmenting the
data with the duration variables u, the failed jump attempt
count matrix, Q, as well as additional auxiliary variables
which we will define below. In this representation the transition matrix is not represented directly, but is a deterministic function of the unscaled transition “rate” matrix, π, and
the similarity matrix, φ. The full set of variables is partitioned into blocks: {γ, α, β, π}, {z, u, Q, Λ}, {θ, `}, and
{ξ}, where Λ represents a set of auxiliary variables that will
be introduced below, θ represents the emission parameters
(which may be further blocked depending on the specific
choice of model), and ξ represents additional parameters
such as any free parameters of the similarity function, φ,
and any hyperparameters of the emission distribution.
3.1. Sampling Transition Parameters and
Hyperparameters
The joint posterior over γ, α, β and π given the augmented
data D = (z, u, Q, Λ) will factor as
p(γ,α, β, π | D)
= p(γ | D)p(α | D)p(β | γ, D)p(π | α, β, D)

One setting in which a local transition property is desirable
is the case where the latent states encode multiple hidden
features at time t as a vector of categories. Such problems
are often modeled using factorial HMMs (Ghahramani
et al., 1997). In fact, the HDP-HMM-LT yields the factorial
HMM in the limit as α, γ → ∞, fixing each row of π to be

(14)

We describe these four factors in reverse order.
Sampling π Having used data augmentation to simplify the likelihood for π to the factored conjugate form
in (13), the individual πjj 0 are a posteriori independent

An Infinite HMM With Similarity-Biased Transitions

Gamma(αβj 0 + njj 0 + qjj 0 , 1 + uj ) distributed.

3.2. Sampling z and the auxiliary variables

Sampling β To enable joint sampling of z, we employ
a weak limit approximation to the HDP (Johnson & Willsky, 2013), approximating the stick-breaking process for β
using a finite Dirichlet distribution with a J components,
where J is larger than we expect to need. Due to the
product-of-Gammas form, we can integrate out π analytically to obtain the marginal likelihood:
J

Γ(γ/J) Y Jγ −1
βj
p(β | γ) =
Γ(γ)
j
p(D | β, α) ∝

J
Y

(1 + uj )−α

j=1

(15)

Y Γ(αβj 0 + njj 0 + qjj 0 )
Γ(αβj 0 )
0
j

where we have used the fact that the βj sum to 1 to pull
out terms of the form (1 + uj )−αβj0 from the inner product in the likelihood. Following Teh et al. (2006), we can
introduce auxiliary variables M = {mjj 0 }, with
ind

m

p(mjj 0 | βj 0 , α, D) ∝ snjj0 +qjj0 ,mjj0 αmjj0 βj 0 jj

0

(16)

We sample the hidden state sequence, z, jointly with the
auxiliary variables, which consist of u, Q, M, r and w.
The joint conditional distribution of these variables is defined directly by the generative model:
p(D) = p(z)p(u | z)p(Q | u)p(M | z, Q)p(r | M)p(w | M)
Since we are conditioning on the transition matrix, we
can sample the entire sequence z jointly with the forwardbackward algorithm, as in an ordinary HMM. Since we are
sampling the labels jointly, this step requires O(T J 2 ) computation per iteration, which is the bottleneck of the inference algorithm for reasonably large T or J (other updates
are constant in T or in J). Having done this, we can sample
u, Q, M, r and w from their forward distributions. It is also
possible to employ a variant on beam sampling (Van Gael
et al., 2008) to speed up each iteration, at the cost of slower
mixing, but we did not use this variant here.
3.3. Sampling state and emission parameters

for integer mjj 0 ranging between 0 and njj 0 + qjj 0 , where
sn,m is an unsigned Stirling number of the first kind. The
normalizing constant in this distribution cancels the ratio of Gamma
functions in the
P
Pβ likelihood, so, letting
0
0
m·j 0 =
j mjj and m·· =
j 0 m·j , the posterior for
(the truncated) β is a Dirichlet whose jth mass parameter
is Jγ + m·j .

Depending on the application, the locations ` may or may
not depend on the emission parameters, θ. If not, sampling
θ conditional on z is unchanged from the HDP-HMM.
There is no general-purpose method for sampling `, or for
sampling θ in the dependent case, due to the dependence
on the form of φ and on the emission model, but specific
instances are illustrated in the experiments below.

Sampling Concentration Parameters Incorporating M
into D, we can integrate out β to obtain

4. Experiments

p(D | α, γ) ∝ αm·· e−

P

j 00

log(1+uj 00 )α

Y Γ( γ + m·j )
Γ(γ)
J
×
Γ(γ + m·· )
Γ( Jγ )
j

(17)

Assuming that α and γ have Gamma priors with shape and
rate parameters aα , bα and aγ , bγ , then
X
α | D ∼ Gamma(aα + m·· , bα +
log(1 + uj )). (18)
j

To simplify the likelihood for γ, we can introduce a final set of auxiliary variables, r = (r1 , . . . , rJ ), rj 0 ∈
{0, . . . , m·j 0 } and w ∈ (0, 1) with the following distributions:
 γ r
p(rj 0 = r | m·j 0 , γ) ∝ s(m·j 0 , r)
(19)
J
γ−1
m·· −1
p(w | m·· γ) ∝ w
(1 − w)
(20)
The normalizing constants are ratios of Gamma functions,
which cancel those in (17), so that
γ | D, r, w ∼ Gamma(aγ + r· , bγ − log(w))

(21)

The parameter space for the hidden states, the associated
prior H on θ, and the similarity function φ, is applicationspecific; we consider here two cases. The first is a speakerdiarization task, where each state consists of a finite Ddimensional binary vector whose entries indicate which
speakers are currently speaking. In this experiment, the
state vectors both determine the pairwise similarities and
partially determine the emission distributions via a linearGaussian model. In the second experiment, the data consists of Bach chorales, and the latent states can be thought
of as harmonic contexts. There, the components of the
states that govern similarities are modeled as independent
of the emission distributions, which are categorical distributions over four-voice chords.
4.1. Cocktail Party
The Data The data was constructed using audio signals
collected from the PASCAL 1st Speech Separation Challenge2 . The underlying signal consisted of D = 16 speaker
channels recorded at each of T = 2000 time steps, with the
2

http://laslab.org/SpeechSeparationChallenge/

An Infinite HMM With Similarity-Biased Transitions

resulting T × D signal matrix, denoted by θ ∗ , mapped to
K = 12 microphone channels via a weight matrix, W. The
16 speakers were grouped into 4 conversational groups of
4, where speakers within a conversation took turns speaking (see Fig. 2). In such a task, there are naively 2D possible states (here, 65536). However, due to the conversational grouping, if at most one speaker in a conversation is
speaking at
Qany given time, the state space is constrained,
with only c (sc + 1) states possible, where sc is the number of speakers in conversation c (in this case sc ≡ 4, for a
total of 625 possible states).
Each “turn” within a conversation consisted of a single
sentence (average duration ∼ 3s) and turn orders within
a conversation were randomly generated, with random
pauses distributed as N (1/4s, (1/4s)2 ) inserted between
sentences. Every time a speaker has a turn, the sentence
is drawn randomly from the 500 sentences uttered by that
speaker in the data. The conversations continued for 40s,
and the signal was down-sampled to length 2000. The ’on’
portions of each speaker’s signal were normalized to have
amplitudes with mean 1 and standard deviation 0.5. An additional column of 1s was added to the speaker signal matrix, θ ∗ , representing background noise. The resulting signal matrix, denoted θ ∗ , was thus 2000 × 17 and the weight
matrix, W, was 17 × 12. Following Gael et al. (2009) and
Valera et al. (2015), the weights were drawn independently
from a Unif(0, 1) distribution, and independent N (0, 0.32 )
noise was added to each entry of the observation matrix.
The Model The latent states, θ j , are the D-dimensional
binary vectors whose dth entry indicates whether or not
speaker d is speaking. The locations `j are identified with
the binary vectors, `j := θ j . We use a Laplacian similarity function on Hamming distance, d0 , so that φjj 0 :=
exp(−λd0 (`j , `j 0 )), λ ≥ 0. The emission model is linearGaussian as in the data, with (D + 1) × K weight matrix
W, and T × (D + 1) signal matrix θ ∗ whose tth row is
θ t := (1, θ zt ), so that yt | z ∼ N (WT θ ∗t , Σ). For the experiments discussed here, we assume that Σ is independent
of j, but this assumption is easily relaxed if appropriate.
For finite-length binary vector states, the set of possible
states is finite, and so it may seem that a nonparametric
model is unnecessary. However, if D is reasonably large,
likely most of the 2D possible states are vanishingly unlikely (and the number of observations may well be less
than 2D ), and so we would like to encourage the selection
of a sparse set of states. Moreover, there could be more
than one state with the same emission parameters, but with
different transition dynamics. Next we describe the additional inference steps needed for this version of the model.
Sampling θ / ` Since θ j and `j are identified, influencing
both the transition matrix and the emission distributions,

both the state sequence z and the observation matrix Y are
used in the update. We put independent Beta-Bernoulli priors on each coordinate of θ, and Gibbs sample each coordinate θjd conditioned on all the others and the coordinatewise prior means, {µd }, which we sample in turn conditioned on θ. Details are in the supplement.
Sampling λ The λ parameter of the similarity function
governs the connection between ` and φ. Substituting the
definition of φ into (13) yields
YY
e−λdjj0 njj0 (1 − e−λdjj0 )qjj0 (22)
p(z, Q | `, λ) ∝
j

j0

We put an Exp(bλ ) prior on λ, which yields a posterior
density
P P

p(λ | z, Q, `) ∝ e−(bλ + j j0 djj0 njj0 )λ
YY
(1 − e−λdjj0 )qjj0
×
j

(23)

j0

This density is log-concave, and so we use Adaptive Rejection Sampling (Gilks & Wild, 1992) to sample from it.
Sampling W and Σ Conditioned on Y and θ ∗ , W and
Σ can be sampled as in Bayesian linear regression. If
each column of W has a multivariate Normal prior, then
the columns are a posteriori independent multivariate Normals. For the experiments reported here, we fix W to its
ground truth value so that θ ∗ can be compared directly with
the ground truth signal matrix, and we constrain Σ to be
diagonal, with Inverse Gamma priors on the variances, resulting in conjugate updates.
Results We attempted to infer the binary speaker matrices using five models: (1) a binary-state Factorial HMM
(Ghahramani et al., 1997), where individual binary speaker
sequences are modeled as independent, (2) an ordinary
HDP-HMM without local transitions (Teh et al., 2006),
where the latent states are binary vectors, (3) a Sticky HDPHMM (Fox et al., 2008), (4) our HDP-HMM-LT model,
and (5) a model that combines the Sticky and LT properties3 . For all models, all concentration and noise precision parameters are given Gamma(0.1, 0.1) priors. For the
κ
is given a Unif(0, 1) prior.
Sticky models, the ratio α+κ
We evaluated the models at each iteration using both the
Hamming distance between inferred and ground truth state
matrices and F1 score. We also plot the inferred decay rate
λ, and the number of states used by the LT and Sticky-LT
models. The results for the five models are in Fig. 1. In
3
We attempted to add a comparison to the DILN-HMM (Zhu
et al., 2016) as well, but code could not be obtained, and the paper
did not provide enough detail to reproduce their inference algorithm.

BFact
LT
noLT
Sticky
StickyLT

10
0
0.5

0.6

0.7

0.8

F1_score

Groundtruth

model

20

StickyLT

density

An Infinite HMM With Similarity-Biased Transitions

1.5
●

1.0

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

model

●

●

LT

lambda

2.0

LT
StickyLT

1000

2000

3000

4000

BFact

0.5
5000

Iterations

LT
noLT
Sticky
StickyLT

0.05
0.00
25

50

75

100

125

n_dot

Figure 1. Top: F1 score for inferred relative to ground truth binary speaker matrices on cocktail party data, evaluated every 50th
Gibbs iteration after the first 2000, aggregating across 5 runs of
each model. Middle: Inferred λ, for the LT and Sticky-LT models by Gibbs iteration, averaged over 5 runs. Bottom: Number of
states used, n· , by each model in the training set. Error bands are
99% confidence interval of the mean per iteration.

Fig. 2, we plot the ground truth state matrix against the average state matrix, η ∗ , averaged over runs and post-burn-in
iterations.
The LT and Sticky-LT models outperform the others, while
the regular Sticky model exhibits only a small advantage
over the vanilla HDP-HMM. Both converge on a nonnegligible λ value of about 1.6 (see Fig. 1), suggesting that
the local transition structure explains the data well. The
LT models also use more states than the non-LT models,
perhaps owing to the fact that the weaker transition prior
of the non-LT model is more likely to explain nearby similar observations as a single persisting state, whereas the LT
model places a higher probability on transitioning to a new
state with a similar latent vector.
4.2. Synthetic Data Without Local Transitions
We generated data directly from the ordinary HDP-HMM
used in the cocktail experiment as a sanity check, to examine the performance of the LT model in the absence of a
similarity bias. The results are in Fig. 3. When the λ parameter is large, the LT model has worse performance than
the non-LT model on this data; however, the λ parameter
settles near zero as the model learns that local transitions
are not more probable. When λ = 0, the HDP-HMM-LT is
an ordinary HDP-HMM. The LT model does not make entirely the same inferences as the non-LT model, however; in
particular, the α concentration parameter is larger. To some
extent, α and λ trade off: sparsity of the transition matrix
can be achieved either by beginning with a sparse rate matrix prior to rescaling (α small), or by beginning with a less
sparse rate matrix which becomes sparser through rescaling

Sticky

model

0.10

noLT

density

0.15

Figure 2. Binary speaker matrices for the cocktail data, with time
on the horizontal axis and speaker on the vertical axis. White
is 1, black is 0. The ground truth matrix is at the top, followed by the inferred speaker matrix for the Sticky HDP-HMMLT, HDP-HMM-LT, binary factorial, Sticky-HDP-HMM, and
“vanilla” HDP-HMM. All inferred matrices are averaged over 5
runs of 5000 Gibbs iterations each, with the first 2000 iterations
discarded as burn-in.

(larger α and non-zero λ).
4.3. Bach Chorales
To test a version of the HDP-HMM-LT model in which the
components of the latent state governing similarity are unrelated to the emission distributions, we used our model
to do unsupervised “grammar” learning from a corpus of
Bach chorales. The data was a corpus of 217 four-voice
major key chorales by J.S. Bach from music214 , 200 of
which were randomly selected as a training set, with the
other 17 used as a test set to evaluate surprisal (marginal
log likelihood per observation) by the trained models. All
chorales were transposed to C-major, and each distinct
four-voice chord (with voices ordered) was encoded as a
single integer. In total there were 3307 distinct chord types
and 20401 chord tokens in the 217 chorales, with 3165
types and 18818 tokens in the 200 training chorales, and
143 chord types that were unique to the test set.
Modifications to Model and Inference Since the chords
were encoded as integers, the emission distribution for each
state is Cat(θ j ). We use a symmetric Dirichlet prior for
each θ j , resulting in conjugate updates to θ conditioned on
the latent state sequence, z.
In this experiment, the locations, `j , are independent of the
θ j , with N (0, I) priors. We use a Gaussian similarity function, φjj := exp{−λd2 (`j , `j 0 )2 } where d2 is Euclidean
distance. Since the latent states are continuous, we use
4

http://web.mit.edu/music21

An Infinite HMM With Similarity-Biased Transitions
6

model

0.9

BFact
LT
noLT

●

0.8

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

0.7
0.6

500

1000

1500

density

F1_score

1.0

model
LT
noLT
Sticky
StickyLT

4
2
0
−5.2

2000

−5.0

12

−4.6

−4.4

1.5

8

model

4
●
●

0

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

●

LT

density

lambda

−4.8

train_log_likelihood

Iterations

model

1.0

LT
noLT
Sticky
StickyLT

0.5

−4
0.0
500

1000

1500

−15

2000

density

0.10

model
LT
noLT

0.05
0.00
0

10

20

30

−14

−13

−12

−11

test_log_likelihood

Iterations

Figure 4. Training set and test set log marginal likelihoods for
Bach chorale data on the four HDP-based models: HDP-HMMLT, HDP-HMM, Sticky HMM, and Sticky HDP-HMM-LT.

40

n_dot

Figure 3. Top: F1 score for inferred relative to ground truth binary speaker matrices on synthetic data generated from the vanilla
HDP-HMM model. Middle: Learned similarity parameter, λ, for
the LT model by Gibbs iteration, averaged over 5 runs. Bottom:
Number of states used, n· , by each model in the training set. Error
bands are 99% confidence interval of the mean per iteration. The
first 100 iterations are omitted.

a Hamiltonian Monte Carlo (HMC) update (Duane et al.,
1987; Neal et al., 2011) to update the `j simultaneously,
conditioned on z and π (see the supplement for details).
Results We ran 5 Gibbs chains for 10,000 iterations each
using the HDP-HMM-LT, Sticky-HDP-HMM-LT, HDPHMM and Sticky-HDP-HMM models on the 200 training
chorales, which were modeled as conditionally independent of one another. We evaluated the marginal log likelihood on the 17 test chorales (integrating out z) at every
50th iteration. The training and test log likelihoods are in
Fig. 4. Although the LT model does not achieve as close
a fit to the training data, its generalization performance is
better, suggesting that the vanilla HDP-HMM is overfitting. This is perhaps counterintuitive, since the LT model
is more flexible, and might be expected to be more prone
to overfitting. However, the similarity bias induces greater
information sharing across parameters, as in a hierarchical
model: instead of each entry of the transition matrix being informed mainly by transitions directly involving the
corresponding states, it is informed to some extent by all
transitions, as they all inform the similarity structure.

5. Discussion
We have defined a new probabilistic model, the Hierarchical Dirichlet Process Hidden Markov Model with Local Transitions (HDP-HMM-LT), which generalizes the
HDP-HMM by allowing state space geometry to be represented via a similarity kernel, making transitions between
“nearby” pairs of states (“local” transitions), more likely a
priori. By introducing an augmented data representation,

which we call the Markov Jump Process with Failed Transitions (MJP-FT), we obtain a Gibbs sampling algorithm
that simplifies inference in both the LT and ordinary HDPHMM. When multiple latent chains are interdependent, as
in speaker diarization, the HDP-HMM-LT model combines
the HDP-HMM’s capacity to discover a small set of joint
states with the Factorial HMM’s ability to encode the property that most transitions involve a small number of chains.
The HDP-HMM-LT outperforms both, as well as outperforming the Sticky-HDP-HMM, on a speaker diarization
task in which speakers form conversational groups. Despite
the addition of the similarity kernel, the HDP-HMM-LT is
able to suppress its local transition prior when the data does
not support it, achieving identical performance to the HDPHMM on data generated directly from the latter.
The local transition property is particularly clear when
transitions occur at different times for different latent features, as with binary vector-valued states in the cocktail
party setting, but the model can be used with any state
space equipped with a suitable similarity kernel. Similarities need not be defined in terms of emission parameters;
state “locations” can be represented and inferred separately,
which we demonstrate using Bach chorale data. There,
the LT model achieves better predictive performance on a
held-out test set, while the ordinary HDP-HMM overfits
the training set: the LT property here acts to encourage a
concise harmonic representation where chord contexts are
arranged in bidirectional functional relationships.
We focused on fixed-dimension binary vectors for the cocktail party and synthetic data experiments, but it would be
straightforward to add the LT property to a model with nonparametric latent states, such as the iFHMM (Gael et al.,
2009) and the infinite factorial dynamic model (Valera
et al., 2015), both of which use the Indian Buffet Process
(IBP) (Ghahramani & Griffiths, 2005) as a state prior. The
similarity function used here could be employed without
changes: since only finitely many coordinates are non-zero
in the IBP, the distance between any two states is finite.

An Infinite HMM With Similarity-Biased Transitions

ACKNOWLEDGMENTS
This work was funded in part by DARPA grant W911NF14-1-0395 under the Big Mechanism Program and DARPA
grant W911NF-16-1-0567 under the Communicating with
Computers Program.

References
Beal, Matthew J, Ghahramani, Zoubin, and Rasmussen,
Carl E. The infinite hidden Markov model. In Advances
in neural information processing systems, pp. 577–584,
2001.
Duane, Simon, Kennedy, Anthony D, Pendleton, Brian J,
and Roweth, Duncan. Hybrid monte carlo. Physics letters B, 195(2):216–222, 1987.
Ewens, Warren John. Population genetics theory – the past
and the future. In Mathematical and Statistical Developments of Evolutionary Theory, pp. 177–227. Springer,
1990.
Favaro, Stefano, Teh, Yee Whye, et al. MCMC for normalized random measure mixture models. Statistical Science, 28(3):335–359, 2013.
Ferguson, Thomas S. A Bayesian analysis of some nonparametric problems. The annals of statistics, pp. 209–
230, 1973.
Fox, Emily B, Sudderth, Erik B, Jordan, Michael I, and
Willsky, Alan S. An HDP-HMM for systems with state
persistence. In Proceedings of the 25th international
conference on Machine learning, pp. 312–319. ACM,
2008.
Gael, Jurgen V, Teh, Yee W, and Ghahramani, Zoubin. The
infinite factorial hidden Markov model. In Advances in
Neural Information Processing Systems, pp. 1697–1704,
2009.
Ghahramani, Zoubin and Griffiths, Thomas L. Infinite latent feature models and the Indian buffet process. In
Advances in neural information processing systems, pp.
475–482, 2005.
Ghahramani, Zoubin, Jordan, Michael I, and Smyth,
Padhraic. Factorial hidden Markov models. Machine
learning, 29(2-3):245–273, 1997.
Gilks, Walter R and Wild, Pascal. Adaptive rejection sampling for Gibbs sampling. Applied Statistics, pp. 337–
348, 1992.
Ishwaran, Hemant and Zarepour, Mahmoud. Exact and approximate sum representations for the Dirichlet process.
Canadian Journal of Statistics, 30(2):269–283, 2002.

Johnson, Matthew J and Willsky, Alan S. Bayesian nonparametric hidden semi-Markov models. The Journal of
Machine Learning Research, 14(1):673–701, 2013.
Kingman, John. Completely random measures. Pacific
Journal of Mathematics, 21(1):59–78, 1967.
Neal, Radford M et al. MCMC using Hamiltonian dynamics. Handbook of Markov Chain Monte Carlo, 2:113–
162, 2011.
Paisley, John, Wang, Chong, and Blei, David M. The discrete infinite logistic normal distribution. Bayesian Analysis, 7(4):997–1034, 2012.
Ranganath, Rajesh and Blei, David M. Correlated random
measures. Journal of the American Statistical Association, 2016.
Sethuraman, Jayaram. A constructive definition of Dirichlet processes. Statistica Sinica, 4:639–650, 1994.
Teh, Yee Whye, Jordan, Michael I, Beal, Matthew J, and
Blei, David M. Hierarchical Dirichlet processes. Journal
of the American Statistical Association, 101(476), 2006.
Valera, Isabel, Ruiz, Francisco, Svensson, Lennart, and
Perez-Cruz, Fernando. Infinite factorial dynamical
model. In Advances in Neural Information Processing
Systems, pp. 1657–1665, 2015.
Van Gael, Jurgen, Saatci, Yunus, Teh, Yee Whye, and
Ghahramani, Zoubin. Beam sampling for the infinite
hidden Markov model. In Proceedings of the 25th International Conference on Machine Learning, pp. 1088–
1095. ACM, 2008.
Zhu, Hao, Hu, Jinsong, and Leung, Henry. Hidden Markov
models with discrete infinite logistic normal distribution
priors. In Information Fusion (FUSION), 2016 19th International Conference on, pp. 429–433. IEEE, 2016.

